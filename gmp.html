<!DOCTYPE html>
<html>
<head>
    <title>Live Flight Tracker</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .info-window {
            font-family: Arial, sans-serif;
            padding: 10px;
            max-width: 300px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA6myHzS10YXdcazAFalmXvDkrYCp5cLc8&callback=initMap"></script>
    <script>
        async function getRotatedIcon(url, rotation, size = 32) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous'; // To avoid CORS issues
                img.src = url + '?color=000000'; // Add param if needed for icons8
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const canvasSize = size * Math.sqrt(2); // To fit rotated image
                    canvas.width = canvasSize;
                    canvas.height = canvasSize;
                    const ctx = canvas.getContext('2d');
                    ctx.translate(canvasSize / 2, canvasSize / 2);
                    ctx.rotate(rotation * Math.PI / 180);
                    ctx.drawImage(img, -size / 2, -size / 2, size, size);
                    resolve(canvas.toDataURL());
                };
                img.onerror = () => {
                    console.error('Error loading image:', url);
                    resolve(url); // Fallback to original
                };
            });
        }

        function initMap() {
            // Initialize standard Google Map
            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 35.693, lng: 51.330 },
                zoom: 6
            });

            const airplaneUrl = 'https://img.icons8.com/external-icongeek26-glyph-icongeek26/64/external-airplane-transportation-icongeek26-glyph-icongeek26-6.png';
            const droneUrl = 'https://img.icons8.com/wired/64/drone-bottom-view.png';

            // Fetch live flight data from FlightRadar24
            async function fetchFlightData() {
                try {
                    const response = await fetch('https://data-cloud.flightradar24.com/zones/fcgi/zone.js?adsb=1&mlat=1&flarm=1&estimated=1&air=1&gnd=1&vehicles=1&gliders=1');
                    const text = await response.text();
                    // Parse JSON manually (removing any non-JSON prefix if needed)
                    const jsonStart = text.indexOf('{');
                    const jsonData = JSON.parse(text.substring(jsonStart));
                    return jsonData;
                } catch (error) {
                    console.error('Error fetching flight data:', error);
                    return {};
                }
            }

            let markers = [];

            // Process and display flights
            async function updateFlights() {
                const flightData = await fetchFlightData();

                // Clear existing markers
                markers.forEach(marker => marker.setMap(null));
                markers = [];

                // Iterate through flight data
                for (const flightId in flightData) {
                    if (flightId === 'full_count' || flightId === 'version') continue;

                    const flight = flightData[flightId];
                    if (flight.length < 19) continue;

                    const [
                        icao, lat, lng, heading, altitude, speed, squawk, radar,
                        aircraftType, registration, timestamp, origin, destination,
                        flightNumber, isGround, verticalSpeed, callsign, unknown, airline
                    ] = flight;

                    // Skip if latitude, longitude, or invalid data
                    if (!lat || !lng || isNaN(lat) || isNaN(lng)) continue;

                    const isDrone = aircraftType.toUpperCase().includes('DRON') || aircraftType.toUpperCase().includes('UAV') || aircraftType === 'QUAD';

                    const iconUrl = isDrone ? droneUrl : airplaneUrl;
                    const rotation = parseInt(heading) || 0;
                    const rotatedUrl = await getRotatedIcon(iconUrl, rotation);

                    // Create marker for each flight
                    const marker = new google.maps.Marker({
                        position: { lat: parseFloat(lat), lng: parseFloat(lng) },
                        map: map,
                        icon: {
                            url: rotatedUrl,
                            scaledSize: new google.maps.Size(32, 32),
                            anchor: new google.maps.Point(16, 16)
                        },
                        title: callsign || flightNumber || registration || 'Unknown'
                    });

                    // Convert timestamp to readable date
                    const flightTime = new Date(timestamp * 1000).toUTCString();

                    // Create info window with all 19 parameters
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div class="info-window">
                                <h3>${callsign || flightNumber || 'Unknown Flight'}</h3>
                                <p>ICAO: ${icao || 'N/A'}</p>
                                <p>Latitude: ${lat || 'N/A'}</p>
                                <p>Longitude: ${lng || 'N/A'}</p>
                                <p>Heading: ${heading || 'N/A'}Â°</p>
                                <p>Altitude: ${altitude ? altitude + ' ft' : 'N/A'}</p>
                                <p>Speed: ${speed ? speed + ' knots' : 'N/A'}</p>
                                <p>Squawk: ${squawk || 'N/A'}</p>
                                <p>Radar: ${radar || 'N/A'}</p>
                                <p>Aircraft Type: ${aircraftType || 'N/A'}</p>
                                <p>Registration: ${registration || 'N/A'}</p>
                                <p>Timestamp: ${flightTime || 'N/A'}</p>
                                <p>Origin: ${origin || 'N/A'}</p>
                                <p>Destination: ${destination || 'N/A'}</p>
                                <p>Flight Number: ${flightNumber || 'N/A'}</p>
                                <p>On Ground: ${isGround ? 'Yes' : 'No'}</p>
                                <p>Vertical Speed: ${verticalSpeed ? verticalSpeed + ' ft/min' : 'N/A'}</p>
                                <p>Callsign: ${callsign || 'N/A'}</p>
                                <p>Unknown: ${unknown || 'N/A'}</p>
                                <p>Airline: ${airline || 'N/A'}</p>
                            </div>
                        `
                    });

                    // Add click listener for popup
                    marker.addListener('click', () => {
                        infoWindow.open(map, marker);
                    });

                    markers.push(marker);
                }

                // Refresh flight data every 10 seconds
                setTimeout(updateFlights, 10000);
            }

            // Initial call to load flights
            updateFlights();
        }
    </script>
</body>
</html>