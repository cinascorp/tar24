

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5">
    <title>TAR24 Advanced C4ISR Command & Control System</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --accent-green: #00ff41;
            --accent-red: #ff0000;
            --accent-orange: #ffaa00;
            --accent-blue: #0066cc;
            --accent-purple: #8a2be2;
            --text-primary: #ffffff;
            --text-secondary: #bfbfbf;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            --glow: 0 0 20px rgba(0, 255, 65, 0.3);
            --panel: #253c63;
            --text: #ffd400;
            --border: #333a42;
            --muted: #9aa2aa;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', 'Arial', sans-serif;
            background: linear-gradient(135deg, #071016 0%, #0a0a0a 50%, #0f0f0f 100%);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-green);
            text-shadow: var(--glow);
        }

        .version {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .threat-level {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .threat-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 2s infinite;
        }

        .threat-indicator.high {
            background: var(--accent-orange);
            animation: pulse 1s infinite;
        }

        .threat-indicator.critical {
            background: var(--accent-red);
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-content {
            display: flex;
            height: 100vh;
            padding-top: 60px;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            transition: width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-green);
            margin-bottom: 5px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            color: var(--accent-green);
        }

        /* Flight List */
        .flight-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .flight-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .flight-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-green);
        }

        .flight-item.selected {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--accent-green);
        }

        .flight-callsign {
            font-weight: 600;
            color: var(--accent-green);
            margin-bottom: 4px;
        }

        .flight-details {
            font-size: 12px;
            color: var(--text-secondary);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .pagination button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Map Container */
        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Controls */
        .map-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-button {
            background: rgba(26, 26, 26, 0.9);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .control-button:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: var(--accent-green);
        }

        /* Statistics Panel */
        .stats-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
            min-width: 300px;
        }

        .stats-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-green);
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--accent-green);
            font-size: 18px;
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }
            
            .stats-panel {
                min-width: 250px;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-green);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-green);
            opacity: 0.8;
        }
    </style>


    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Initializing TAR24 v4 System...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">TAR24 v4</div>
            <div class="version">Command & Control System</div>
        </div>
        <div class="threat-level">
            <div id="threatIndicator" class="threat-indicator"></div>
            <span id="threatLevel">LOW THREAT</span>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Flight Control</div>
                <div class="sidebar-subtitle">Real-time Monitoring</div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">
                    <i class="fas fa-plane"></i>
                    Active Flights
                </div>
                <div class="flight-list" id="flightList">
                    <!-- Flight items will be populated here -->
                </div>
                
                <!-- Pagination -->
                <div class="pagination">
                    <button id="prevPage" onclick="previousPage()">‹</button>
                    <span class="page-info" id="pageInfo">Page 1 of 1</span>
                    <button id="nextPage" onclick="nextPage()">›</button>
                </div>
            </div>
            
            <div class="sidebar-section">
                <div class="section-title">
                    <i class="fas fa-filter"></i>
                    Filters
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: var(--text-secondary);">
                        Aircraft Type:
                    </label>
                    <select id="aircraftType" style="width: 100%; padding: 8px; background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 4px;">
                        <option value="">All Types</option>
                        <option value="military">Military</option>
                        <option value="passenger">Passenger</option>
                        <option value="cargo">Cargo</option>
                        <option value="private">Private</option>
                        <option value="drone">Drone/UAV</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: var(--text-secondary);">
                        Altitude Range (ft):
                    </label>
                    <input type="range" id="altitudeRange" min="0" max="50000" value="50000" style="width: 100%;">
                    <div style="text-align: center; font-size: 12px; color: var(--text-secondary);">
                        <span id="altitudeValue">50,000</span> ft
                    </div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-size: 12px; color: var(--text-secondary);">
                        Speed Range (knots):
                    </label>
                    <input type="range" id="speedRange" min="0" max="1000" value="1000" style="width: 100%;">
                    <div style="text-align: center; font-size: 12px; color: var(--text-secondary);">
                        <span id="speedValue">1,000</span> knots
                    </div>
                </div>
            </div>
        </aside>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Map Controls -->
            <div class="map-controls">
                <button class="control-button" id="toggleSidebar" title="Toggle Sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="control-button" id="refreshData" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="control-button" id="centerMap" title="Center Map">
                    <i class="fas fa-crosshairs"></i>
                </button>
            </div>
            
            <!-- Statistics Panel -->
            <div class="stats-panel" id="statsPanel">
                <div class="stats-title">Real-time Statistics</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalFlights">0</div>
                        <div class="stat-label">Total Flights</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="militaryFlights">0</div>
                        <div class="stat-label">Military</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="threats">0</div>
                        <div class="stat-label">Threats</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dataAge">0s</div>
                        <div class="stat-label">Data Age</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // TAR24 v4 - Advanced C4ISR Command & Control System
        // Pure JavaScript implementation for Android Web Framework
        // Real-time FlightRadar24 integration with all 19 parameters
        
        (function() {
            'use strict';
            
            // Global variables
            let map;
            let flightMarkers = [];
            let allFlights = [];
            let currentPage = 1;
            const flightsPerPage = 1500;
            let lastUpdateTime = Date.now();
            let autoUpdateTimer;
            
            // Flight data structure with all 19 parameters
            const FLIGHT_PARAMETERS = {
                HEX: 'hex',           // ICAO24 hex code
                LAT: 'lat',           // Latitude
                LON: 'lon',           // Longitude
                ALT_FT: 'alt_ft',     // Altitude in feet
                ALT_M: 'alt_m',       // Altitude in meters
                SPEED_KTS: 'speed_kts', // Speed in knots
                SPEED_KMH: 'speed_kmh', // Speed in km/h
                HEADING: 'heading',   // Heading in degrees
                CALLSIGN: 'callsign', // Flight callsign
                REGISTRATION: 'reg',  // Aircraft registration
                AIRCRAFT_TYPE: 'acType', // Aircraft type code
                ORIGIN: 'origin',     // Origin airport
                DESTINATION: 'dest',  // Destination airport
                FLIGHT_NUMBER: 'flightNumber', // Flight number
                AIRLINE: 'airline',   // Airline code
                VERTICAL_RATE: 'vsi', // Vertical speed indicator
                SQUAWK: 'squawk',     // Transponder code
                TIMESTAMP: 'ts',      // Last update timestamp
                STATUS: 'status'      // Flight status
            };
            
            // Aircraft icons and colors
            const AIRCRAFT_ICONS = {
                MILITARY: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwxOSA5TDEzLjA5IDkuNzRMMTIgMTZMMTAuOTEgOS43NEw1IDlMMTAuOTEgOC4yNkwxMiAyWiIgZmlsbD0iI2ZmMDAwMCIvPgo8L3N2Zz4K',
                PASSENGER: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwxOSA5TDEzLjA5IDkuNzRMMTIgMTZMMTAuOTEgOS43NEw1IDlMMTAuOTEgOC4yNEwxMiAyWiIgZmlsbD0iIzAwZmY0MSIvPgo8L3N2Zz4K',
                CARGO: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwxOSA5TDEzLjA5IDkuNzRMMTIgMTZMMTAuOTEgOS43NEw1IDlMMTAuOTEgOC4yNEwxMiAyWiIgZmlsbD0iIzAwNjZjYyIvPgo8L3N2Zz4K',
                PRIVATE: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwxOSA5TDEzLjA5IDkuNzRMMTIgMTZMMTAuOTEgOS43NEw1IDlMMTAuOTEgOC4yNEwxMiAyWiIgZmlsbD0iI2ZmYWEwMCIvPgo8L3N2Zz4K',
                DRONE: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwxOSA5TDEzLjA5IDkuNzRMMTIgMTZMMTAuOTEgOS43NEw1IDlMMTAuOTEgOC4yNEwxMiAyWiIgZmlsbD0iIzhhMmJlMiIvPgo8L3N2Zz4K'
            };
            
            const AIRCRAFT_COLORS = {
                MILITARY: '#ff0000',
                PASSENGER: '#00ff41',
                CARGO: '#0066cc',
                PRIVATE: '#ffaa00',
                DRONE: '#8a2be2'
            };
            
            // Initialize the system
            function init() {
                initMap();
                setupEventListeners();
                startRealTimeUpdates();
                hideLoadingScreen();
            }
            
            // Initialize Leaflet map
            function initMap() {
                map = L.map('map', {
                    center: [35.6892, 51.3890], // Tehran coordinates
                    zoom: 6,
                    minZoom: 3,
                    maxZoom: 18,
                    zoomControl: false
                });
                
                // Add dark tile layer
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '©CartoDB',
                    subdomains: 'abcd',
                    maxZoom: 19
                }).addTo(map);
                
                // Add zoom control
                L.control.zoom({
                    position: 'bottomright'
                }).addTo(map);
            }
            
            // Setup event listeners
            function setupEventListeners() {
                // Toggle sidebar
                document.getElementById('toggleSidebar').addEventListener('click', toggleSidebar);
                
                // Refresh data
                document.getElementById('refreshData').addEventListener('click', refreshFlightData);
                
                // Center map
                document.getElementById('centerMap').addEventListener('click', centerMap);
                
                // Filters
                document.getElementById('aircraftType').addEventListener('change', applyFilters);
                document.getElementById('altitudeRange').addEventListener('input', updateAltitudeValue);
                document.getElementById('speedRange').addEventListener('input', updateSpeedValue);
            }
            
            // Toggle sidebar
            function toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('collapsed');
            }
            
            // Update altitude value display
            function updateAltitudeValue() {
                const range = document.getElementById('altitudeRange');
                const value = document.getElementById('altitudeValue');
                value.textContent = parseInt(range.value).toLocaleString();
                applyFilters();
            }
            
            // Update speed value display
            function updateSpeedValue() {
                const range = document.getElementById('speedRange');
                const value = document.getElementById('speedValue');
                value.textContent = parseInt(range.value).toLocaleString();
                applyFilters();
            }
            
            // Center map on current view
            function centerMap() {
                map.setView([35.6892, 51.3890], 6);
            }
            
            // Hide loading screen
            function hideLoadingScreen() {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 2000);
            }
            
            // Start real-time updates
            function startRealTimeUpdates() {
                refreshFlightData();
                autoUpdateTimer = setInterval(refreshFlightData, 10000); // Update every 10 seconds
            }
            
            // Refresh flight data from FlightRadar24
            async function refreshFlightData() {
                try {
                    console.log('Fetching real-time flight data from FlightRadar24...');
                    const flightData = await fetchFlightRadar24Data();
                    
                    if (flightData && flightData.flights) {
                        allFlights = flightData.flights;
                        currentPage = 1;
                        updateFlightDisplay();
                        updateStatistics();
                        updateThreatLevel();
                        lastUpdateTime = Date.now();
                        updateDataAge();
                    }
                } catch (error) {
                    console.error('Error refreshing flight data:', error);
                }
            }
            
            // Fetch data from FlightRadar24 API
            async function fetchFlightRadar24Data() {
                try {
                    const bounds = getMapBounds();
                    const params = new URLSearchParams({
                        faa: '1',
                        satellite: '1',
                        mlat: '1',
                        flarm: '1',
                        adsb: '1',
                        gnd: '1',
                        air: '1',
                        vehicles: '1',
                        estimated: '1',
                        maxage: '14400',
                        gliders: '1',
                        stats: '1',
                        bounds: `${bounds.maxLat},${bounds.minLat},${bounds.minLon},${bounds.maxLon}`
                    });
                    
                    // Try multiple FlightRadar24 endpoints for reliability
                    const urls = [
                        `https://data-cloud.flightradar24.com/zones/fcgi/feed.js?${params}`,
                        `https://data-live.flightradar24.com/zones/fcgi/feed.js?${params}`,
                        `https://data-cloud.flightradar24.com/zones/fcgi/js?${params}`
                    ];
                    
                    for (const url of urls) {
                        try {
                            const response = await fetch(url, {
                                cache: 'no-store',
                                headers: {
                                    'Accept': 'application/json, text/javascript, */*; q=0.01',
                                    'User-Agent': 'TAR24-v4/1.0'
                                }
                            });
                            
                            if (!response.ok) continue;
                            
                            const text = await response.text();
                            let data = null;
                            
                            try {
                                data = JSON.parse(text);
                            } catch (e) {
                                // Handle JavaScript function format
                                data = eval('(' + text + ')');
                            }
                            
                            if (data && typeof data === 'object') {
                                return parseFlightRadar24Data(data);
                            }
                        } catch (e) {
                            console.warn(`Failed to fetch from ${url}:`, e);
                            continue;
                        }
                    }
                    
                    throw new Error('All FlightRadar24 endpoints failed');
                } catch (error) {
                    console.error('Error fetching FlightRadar24 data:', error);
                    return { flights: [], fullCount: 0 };
                }
            }
            
            // Parse FlightRadar24 data format
            function parseFlightRadar24Data(data) {
                const flights = [];
                let fullCount = 0;
                
                if (data.full_count) {
                    fullCount = Number(data.full_count) || 0;
                }
                
                // FlightRadar24 data format: each flight is an array with specific indices
                for (const [hex, flightArray] of Object.entries(data)) {
                    if (!Array.isArray(flightArray)) continue;
                    
                    const flight = extractFlightParameters(hex, flightArray);
                    if (flight) {
                        flights.push(flight);
                    }
                }
                
                console.log(`Parsed ${flights.length} flights from FlightRadar24 (Total available: ${fullCount})`);
                return { flights, fullCount };
            }
            
            // Extract all 19 flight parameters from FlightRadar24 array
            function extractFlightParameters(hex, flightArray) {
                try {
                    // FlightRadar24 array indices based on their API documentation
                    const lat = extractNumber(flightArray, 1, -90, 90);
                    const lon = extractNumber(flightArray, 2, -180, 180);
                    const heading = extractNumber(flightArray, 3, 0, 360);
                    const alt_ft = extractNumber(flightArray, 4, 0, 65000);
                    const speed_kts = extractNumber(flightArray, 5, 0, 1000);
                    const vSpeed = extractNumber(flightArray, 6, -10000, 10000);
                    const callsign = extractString(flightArray, 7);
                    const reg = extractString(flightArray, 8);
                    const acType = extractString(flightArray, 9);
                    const squawk = extractString(flightArray, 10);
                    const flightNumber = extractString(flightArray, 11);
                    const origin = extractString(flightArray, 12);
                    const dest = extractString(flightArray, 13);
                    const airline = extractString(flightArray, 14);
                    const status = extractString(flightArray, 15);
                    
                    // Validate essential coordinates
                    if (lat === null || lon === null) {
                        return null;
                    }
                    
                    return {
                        hex: hex,
                        lat: lat,
                        lon: lon,
                        heading: heading,
                        alt_ft: alt_ft,
                        alt_m: alt_ft ? Math.round(alt_ft * 0.3048) : null,
                        speed_kts: speed_kts,
                        speed_kmh: speed_kts ? Math.round(speed_kts * 1.852) : null,
                        vsi: vSpeed,
                        callsign: callsign,
                        reg: reg,
                        acType: acType,
                        squawk: squawk,
                        flightNumber: flightNumber,
                        origin: origin,
                        dest: dest,
                        airline: airline,
                        status: status,
                        ts: Date.now()
                    };
                } catch (error) {
                    console.warn('Error extracting flight parameters:', error);
                    return null;
                }
            }
            
            // Helper function to extract and validate numbers
            function extractNumber(array, index, min, max) {
                if (index >= array.length) return null;
                const value = Number(array[index]);
                if (isFinite(value) && value >= min && value <= max) {
                    return value;
                }
                return null;
            }
            
            // Helper function to extract and validate strings
            function extractString(array, index) {
                if (index >= array.length) return null;
                const value = array[index];
                if (typeof value === 'string' && value.trim()) {
                    return value.trim();
                }
                return null;
            }
            
            // Get current map bounds
            function getMapBounds() {
                const bounds = map.getBounds();
                return {
                    minLat: bounds.getSouth(),
                    maxLat: bounds.getNorth(),
                    minLon: bounds.getWest(),
                    maxLon: bounds.getEast()
                };
            }
            
            // Update flight display with pagination
            function updateFlightDisplay() {
                clearFlightMarkers();
                
                const filteredFlights = applyFiltersToFlights(allFlights);
                const totalPages = Math.ceil(filteredFlights.length / flightsPerPage);
                const startIndex = (currentPage - 1) * flightsPerPage;
                const endIndex = startIndex + flightsPerPage;
                const pageFlights = filteredFlights.slice(startIndex, endIndex);
                
                // Update pagination info
                updatePaginationInfo(currentPage, totalPages, filteredFlights.length);
                
                // Add flight markers to map
                pageFlights.forEach(flight => {
                    addFlightMarker(flight);
                });
                
                // Update flight list in sidebar
                updateFlightList(pageFlights);
                
                console.log(`Displaying ${pageFlights.length} flights (Page ${currentPage}/${totalPages})`);
            }
            
            // Apply filters to flights
            function applyFiltersToFlights(flights) {
                const aircraftType = document.getElementById('aircraftType').value;
                const maxAltitude = parseInt(document.getElementById('altitudeRange').value);
                const maxSpeed = parseInt(document.getElementById('speedRange').value);
                
                return flights.filter(flight => {
                    // Aircraft type filter
                    if (aircraftType && categorizeAircraft(flight) !== aircraftType) {
                        return false;
                    }
                    
                    // Altitude filter
                    if (flight.alt_ft && flight.alt_ft > maxAltitude) {
                        return false;
                    }
                    
                    // Speed filter
                    if (flight.speed_kts && flight.speed_kts > maxSpeed) {
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // Categorize aircraft type
            function categorizeAircraft(flight) {
                const militaryPrefixes = ['RCH', 'QID', 'LAGR', 'NATO', 'PAT', 'BOMBER', 'USAF', 'RAF', 'AF', 'MIL'];
                const privateRegPatterns = [/^N[0-9A-Z]{1,5}$/i, /^[A-Z]{1,2}-[A-Z]{3,5}$/i];
                const airlineLike = /^[A-Z]{2,3}\d{2,4}[A-Z]?$/;
                
                // Check for drones/UAVs
                if (isDrone(flight)) return 'drone';
                
                // Check for military
                if (flight.callsign && militaryPrefixes.some(p => flight.callsign.toUpperCase().startsWith(p))) {
                    return 'military';
                }
                
                // Check for passenger airlines
                if (flight.callsign && airlineLike.test(flight.callsign)) {
                    return 'passenger';
                }
                
                // Check for private
                if (flight.reg && privateRegPatterns.some(r => r.test(flight.reg))) {
                    return 'private';
                }
                
                return 'cargo';
            }
            
            // Check if aircraft is a drone
            function isDrone(flight) {
                const speed = flight.speed_kts || 0;
                const alt = flight.alt_ft || 0;
                return alt > 0 && alt <= 4000 && speed > 0 && speed <= 120;
            }
            
            // Add flight marker to map
            function addFlightMarker(flight) {
                const category = categorizeAircraft(flight);
                const icon = L.icon({
                    iconUrl: AIRCRAFT_ICONS[category.toUpperCase()] || AIRCRAFT_ICONS.PASSENGER,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12],
                    popupAnchor: [0, -12]
                });
                
                const marker = L.marker([flight.lat, flight.lon], {
                    icon: icon,
                    rotationAngle: flight.heading || 0
                });
                
                // Create popup with all 19 parameters
                const popupContent = createFlightPopup(flight);
                marker.bindPopup(popupContent);
                
                marker.addTo(map);
                flightMarkers.push(marker);
            }
            
                         // Create detailed flight popup
             function createFlightPopup(flight) {
                 const category = categorizeAircraft(flight);
                 const title = flight.callsign || flight.reg || flight.hex;
                 
                 return `
                     <div style="min-width: 300px; font-family: 'Segoe UI', sans-serif;">
                         <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                             <strong style="color: #00ff41; font-size: 16px;">${title}</strong>
                             <span style="background: ${AIRCRAFT_COLORS[category.toUpperCase()] || '#00ff41'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 10px; font-weight: bold;">${category.toUpperCase()}</span>
                         </div>
                         
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                             <div><strong>ICAO24:</strong> ${flight.hex}</div>
                             <div><strong>Registration:</strong> ${flight.reg || '—'}</div>
                             <div><strong>Aircraft Type:</strong> ${flight.acType || '—'}</div>
                             <div><strong>Flight Number:</strong> ${flight.flightNumber || '—'}</div>
                             <div><strong>Airline:</strong> ${flight.airline || '—'}</div>
                             <div><strong>Squawk:</strong> ${flight.squawk || '—'}</div>
                             <div><strong>Origin:</strong> ${flight.origin || '—'}</div>
                             <div><strong>Destination:</strong> ${flight.dest || '—'}</div>
                             <div><strong>Latitude:</strong> ${flight.lat.toFixed(4)}°</div>
                             <div><strong>Longitude:</strong> ${flight.lon.toFixed(4)}°</div>
                             <div><strong>Altitude:</strong> ${flight.alt_ft ? flight.alt_ft + ' ft (' + flight.alt_m + ' m)' : '—'}</div>
                             <div><strong>Speed:</strong> ${flight.speed_kts ? flight.speed_kts + ' kts (' + flight.speed_kmh + ' km/h)' : '—'}</div>
                             <div><strong>Heading:</strong> ${flight.heading ? flight.heading + '°' : '—'}</div>
                             <div><strong>Vertical Speed:</strong> ${flight.vsi ? flight.vsi + ' ft/min' : '—'}</div>
                             <div><strong>Status:</strong> ${flight.status || '—'}</div>
                             <div><strong>Last Update:</strong> ${new Date(flight.ts).toLocaleTimeString()}</div>
                         </div>
                         
                         <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #333; font-size: 11px; color: #999;">
                             Real-time data from FlightRadar24 • TAR24 v4 System
                         </div>
                     </div>
                 `;
             }
             
             // Clear all flight markers
             function clearFlightMarkers() {
                 flightMarkers.forEach(marker => {
                     map.removeLayer(marker);
                 });
                 flightMarkers = [];
             }
             
             // Update flight list in sidebar
             function updateFlightList(flights) {
                 const flightList = document.getElementById('flightList');
                 flightList.innerHTML = '';
                 
                 flights.forEach(flight => {
                     const flightItem = document.createElement('div');
                     flightItem.className = 'flight-item';
                     flightItem.onclick = () => selectFlight(flight);
                     
                     const category = categorizeAircraft(flight);
                     const title = flight.callsign || flight.reg || flight.hex;
                     
                     flightItem.innerHTML = `
                         <div class="flight-callsign">${title}</div>
                         <div class="flight-details">
                             <div>${flight.alt_ft ? flight.alt_ft + ' ft' : '—'}</div>
                             <div>${flight.speed_kts ? flight.speed_kts + ' kts' : '—'}</div>
                             <div>${flight.heading ? flight.heading + '°' : '—'}</div>
                             <div style="color: ${AIRCRAFT_COLORS[category.toUpperCase()] || '#00ff41'}">${category}</div>
                         </div>
                     `;
                     
                     flightList.appendChild(flightItem);
                 });
             }
             
             // Select flight and center map
             function selectFlight(flight) {
                 // Remove previous selection
                 document.querySelectorAll('.flight-item').forEach(item => {
                     item.classList.remove('selected');
                 });
                 
                 // Add selection to clicked item
                 event.target.closest('.flight-item').classList.add('selected');
                 
                 // Center map on flight
                 map.setView([flight.lat, flight.lon], 12);
                 
                 // Open popup
                 const marker = flightMarkers.find(m => 
                     m.getLatLng().lat === flight.lat && m.getLatLng().lng === flight.lon
                 );
                 if (marker) {
                     marker.openPopup();
                 }
             }
             
             // Update pagination info
             function updatePaginationInfo(current, total, totalFlights) {
                 const pageInfo = document.getElementById('pageInfo');
                 const prevBtn = document.getElementById('prevPage');
                 const nextBtn = document.getElementById('nextPage');
                 
                 pageInfo.textContent = `Page ${current} of ${total} (${totalFlights.toLocaleString()} flights)`;
                 
                 prevBtn.disabled = current <= 1;
                 nextBtn.disabled = current >= total;
             }
             
             // Pagination functions
             function previousPage() {
                 if (currentPage > 1) {
                     currentPage--;
                     updateFlightDisplay();
                 }
             }
             
             function nextPage() {
                 const filteredFlights = applyFiltersToFlights(allFlights);
                 const totalPages = Math.ceil(filteredFlights.length / flightsPerPage);
                 
                 if (currentPage < totalPages) {
                     currentPage++;
                     updateFlightDisplay();
                 }
             }
             
             // Apply filters
             function applyFilters() {
                 currentPage = 1;
                 updateFlightDisplay();
             }
             
             // Update statistics
             function updateStatistics() {
                 const filteredFlights = applyFiltersToFlights(allFlights);
                 
                 const stats = {
                     total: filteredFlights.length,
                     military: 0,
                     threats: 0
                 };
                 
                 filteredFlights.forEach(flight => {
                     const category = categorizeAircraft(flight);
                     if (category === 'military') stats.military++;
                     if (category === 'military' || category === 'drone') stats.threats++;
                 });
                 
                 document.getElementById('totalFlights').textContent = stats.total.toLocaleString();
                 document.getElementById('militaryFlights').textContent = stats.military.toLocaleString();
                 document.getElementById('threats').textContent = stats.threats.toLocaleString();
             }
             
             // Update threat level
             function updateThreatLevel() {
                 const militaryCount = allFlights.filter(f => categorizeAircraft(f) === 'military').length;
                 const droneCount = allFlights.filter(f => categorizeAircraft(f) === 'drone').length;
                 
                 const threatIndicator = document.getElementById('threatIndicator');
                 const threatLevel = document.getElementById('threatLevel');
                 
                 if (militaryCount > 5 || droneCount > 10) {
                     threatIndicator.className = 'threat-indicator critical';
                     threatLevel.textContent = 'CRITICAL THREAT';
                 } else if (militaryCount > 2 || droneCount > 5) {
                     threatIndicator.className = 'threat-indicator high';
                     threatLevel.textContent = 'HIGH THREAT';
                 } else if (militaryCount > 0 || droneCount > 0) {
                     threatIndicator.className = 'threat-indicator';
                     threatLevel.textContent = 'MEDIUM THREAT';
                 } else {
                     threatIndicator.className = 'threat-indicator';
                     threatLevel.textContent = 'LOW THREAT';
                 }
             }
             
             // Update data age
             function updateDataAge() {
                 const dataAgeElement = document.getElementById('dataAge');
                 
                 function updateAge() {
                     const age = Math.floor((Date.now() - lastUpdateTime) / 1000);
                     dataAgeElement.textContent = age + 's';
                 }
                 
                 updateAge();
                 setInterval(updateAge, 1000);
             }
             
             // Initialize system when DOM is loaded
             document.addEventListener('DOMContentLoaded', function() {
                 init();
             });
             
             // Global functions for pagination (accessible from HTML)
             window.previousPage = previousPage;
             window.nextPage = nextPage;
             
         })();
     </script>
 
